#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define SIZE 9
#define EMPTY 0
#define NUM_REMOVE 40

int board[SIZE][SIZE];
int solution[SIZE][SIZE];
int error_count = 0;
const int MAX_ERRORS = 5;

// åˆ¤æ–·è©²åˆ—æ˜¯å¦å®‰å…¨
int isRowSafe(int row, int num) {
    for (int col = 0; col < SIZE; col++)
        if (board[row][col] == num)
            return 0;
    return 1;
}

// åˆ¤æ–·è©²æ¬„æ˜¯å¦å®‰å…¨
int isColSafe(int col, int num) {
    for (int row = 0; row < SIZE; row++)
        if (board[row][col] == num)
            return 0;
    return 1;
}

// åˆ¤æ–· 3x3 å€åŸŸæ˜¯å¦å®‰å…¨
int isBoxSafe(int startRow, int startCol, int num) {
    for (int row = 0; row < 3; row++)
        for (int col = 0; col < 3; col++)
            if (board[startRow + row][startCol + col] == num)
                return 0;
    return 1;
}

// ç”¨æ–¼ç”Ÿæˆç›¤é¢çš„å®‰å…¨æª¢æŸ¥ï¼ˆå¡«æ•¸ç”¨ï¼‰
int isSafe(int row, int col, int num) {
    return isRowSafe(row, num) &&
           isColSafe(col, num) &&
           isBoxSafe(row - row % 3, col - col % 3, num);
}

// æª¢æŸ¥ç©å®¶å¡«å…¥æ˜¯å¦åˆæ³•ï¼ˆæ ¹æ“šç•¶å‰ç›¤é¢ï¼‰
int isValidMove(int row, int col, int num) {
    // åŒè¡Œ
    for (int j = 0; j < SIZE; j++)
        if (board[row][j] == num)
            return 0;
    // åŒåˆ—
    for (int i = 0; i < SIZE; i++)
        if (board[i][col] == num)
            return 0;
    // åŒå€
    int startRow = row - row % 3;
    int startCol = col - col % 3;
    for (int i = 0; i < 3; i++)
        for (int j = 0; j < 3; j++)
            if (board[startRow + i][startCol + j] == num)
                return 0;
    return 1;
}

// ä½¿ç”¨å›æº¯æ³•å¡«æ»¿æ•´å€‹ç›¤é¢
int fillBoard() {
    for (int row = 0; row < SIZE; row++) {
        for (int col = 0; col < SIZE; col++) {
            if (board[row][col] == EMPTY) {
                int numbers[SIZE] = {1,2,3,4,5,6,7,8,9};
                for (int i = 0; i < SIZE; i++) {
                    int j = rand() % SIZE;
                    int temp = numbers[i];
                    numbers[i] = numbers[j];
                    numbers[j] = temp;
                }
                for (int i = 0; i < SIZE; i++) {
                    int num = numbers[i];
                    if (isSafe(row, col, num)) {
                        board[row][col] = num;
                        if (fillBoard())
                            return 1;
                        board[row][col] = EMPTY;
                    }
                }
                return 0;
            }
        }
    }
    return 1;
}

// ç§»é™¤æŒ‡å®šæ•¸é‡çš„æ•¸å­—ä½œç‚ºé¡Œç›®
void removeDigits() {
    int count = NUM_REMOVE;
    while (count > 0) {
        int row = rand() % SIZE;
        int col = rand() % SIZE;
        if (board[row][col] != EMPTY) {
            board[row][col] = EMPTY;
            count--;
        }
    }
}

// å°å‡ºç›®å‰ç›¤é¢
void printBoard() {
    for (int i = 0; i < SIZE; i++) {
        if (i % 3 == 0) printf("-------------------------\n");
        for (int j = 0; j < SIZE; j++) {
            if (j % 3 == 0) printf("| ");
            if (board[i][j] == EMPTY)
                printf(". ");
            else
                printf("%d ", board[i][j]);
        }
        printf("|\n");
    }
    printf("-------------------------\n");
}

int main() {
    srand(time(NULL));
    time_t start_time, end_time;

    fillBoard();

    // å„²å­˜æ­£ç¢ºè§£ç­”
    for (int i = 0; i < SIZE; i++)
        for (int j = 0; j < SIZE; j++)
            solution[i][j] = board[i][j];

    removeDigits();

    printf("=== æ•¸ç¨éŠæˆ²é–‹å§‹ ===\n");
    printBoard();

    time(&start_time);  // é–‹å§‹è¨ˆæ™‚

    int r, c, n;
    while (1) {
        printf("è¼¸å…¥ æ ¼å­åˆ— è¡Œ æ•¸å­— (ä¾‹å¦‚: 0 1 5)ï¼Œè¼¸å…¥ -1 çµæŸï¼š");
        scanf("%d", &r);
        if (r == -1) break;
        scanf("%d %d", &c, &n);

        if (r < 0 || r >= SIZE || c < 0 || c >= SIZE || n < 1 || n > 9) {
            printf("âœ˜ è¼¸å…¥ç¯„åœéŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚\n");
            continue;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºé¡Œç›®åŸå§‹æ ¼
        if (solution[r][c] == board[r][c]) {
            printf("âœ˜ æ­¤æ ¼å­ç‚ºé¡Œç›®ï¼Œä¸èƒ½ä¿®æ”¹ï¼\n");
            continue;
        }

        // æª¢æŸ¥æ˜¯å¦é•åæ•¸ç¨è¦å‰‡
        if (!isValidMove(r, c, n)) {
            error_count++;
            printf("âœ˜ é•åæ•¸ç¨è¦å‰‡ï¼šåŒè¡Œã€åŒåˆ—æˆ–åŒå€å·²æœ‰ %dã€‚\n", n);
            printf("ç›®å‰éŒ¯èª¤æ¬¡æ•¸ï¼š%d / %d\n", error_count, MAX_ERRORS);
            if (error_count >= MAX_ERRORS) {
                printf("ğŸ’¥ éŒ¯èª¤æ¬¡æ•¸éå¤šï¼ŒéŠæˆ²çµæŸï¼\n");
                break;
            }
            continue;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºç­”æ¡ˆ
        if (n == solution[r][c]) {
            board[r][c] = n;
            printf("âœ” æ­£ç¢ºå¡«å…¥ï¼\n");
        } else {
            error_count++;
            printf("âœ˜ éŒ¯èª¤ï¼é€™ä¸æ˜¯æ­£ç¢ºç­”æ¡ˆã€‚\n");
            printf("ç›®å‰éŒ¯èª¤æ¬¡æ•¸ï¼š%d / %d\n", error_count, MAX_ERRORS);
            if (error_count >= MAX_ERRORS) {
                printf("ğŸ’¥ éŒ¯èª¤æ¬¡æ•¸éå¤šï¼ŒéŠæˆ²çµæŸï¼\n");
                break;
            }
        }

        printBoard();
    }

    time(&end_time);  // çµæŸè¨ˆæ™‚
    double elapsed = difftime(end_time, start_time);
    printf("â±ï¸ ä½ èŠ±äº† %.0f ç§’å®Œæˆé€™å ´éŠæˆ²ã€‚\n", elapsed);
    printf("ğŸ® æ„Ÿè¬éŠç©æ•¸ç¨éŠæˆ²ï¼\n");
    return 0;
}
